# Containerfile
FROM python:3.12-slim

# Install deps needed for HTTP over unix socket and OpenSearch client
RUN pip install --no-cache-dir \
    requests \
    requests-unixsocket \
    opensearch-py

WORKDIR /app

# Copy in the log collector
COPY agent.py /app/agent.py

# NOTE: We keep the default (root) user inside the container.
# In rootless Podman, this is mapped to your host user anyway,
# and it makes accessing the podman.sock simpler.

# Environment variables (override when running)
ENV PODMAN_SOCKET_PATH=/run/podman/podman.sock \
    OPENSEARCH_URL=http://opensearch:9200 \
    OPENSEARCH_INDEX_PREFIX=podman-logs \
    NODE_NAME=podman-host \
    DISCOVERY_INTERVAL_SECONDS=10 \
    LOG_LEVEL=INFO \
    AGENT_MODE=local

# AGENT_MODE = "opensearch" or "local"

ENTRYPOINT ["python", "/app/agent.py"]